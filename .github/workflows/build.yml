name: Build

on:
  push:
    branches: [ "main", "master" ]
  pull_request: # PR 생성 시에도 빌드 실행 (안전장치)
    branches: [ "main", "master" ]
  workflow_dispatch:

# 보안을 위한 권한 최소화 설정
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 소스코드 체크아웃
        uses: actions/checkout@v4

      - name: Java 21 설치
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # Gradle 공식 액션 사용 (수동 캐싱 설정 불필요)
      # 알아서 Gradle 버전을 감지하고, 의존성과 래퍼를 효율적으로 캐싱합니다.
      - name: Gradle 설정 및 캐싱
        uses: gradle/actions/setup-gradle@v4
        with:
          # 캐시 읽기 전용 여부 등 세부 설정 가능 (기본값 사용 권장)
          cache-read-only: false 

      - name: 빌드 권한 부여
        run: chmod +x gradlew

      - name: Gradle 빌드
        # test를 포함한 전체 빌드 수행
        run: ./gradlew build --no-daemon

      # (선택 사항) 빌드 실패 시 테스트 결과 리포트 저장
      # 빌드가 성공하든 실패하든(always) 혹은 실패시에만 실행되도록 설정 가능
      - name: 테스트 리포트 저장
        if: failure() 
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: build/reports/tests/test/
          retention-days: 5

      - name: JAR 파일 업로드
        uses: actions/upload-artifact@v4
        with:
          name: shoreline-mod-jar
          # 필요에 따라 일반 jar와 plain jar 중 실행 가능한 것만 골라낼 수도 있습니다.
          path: build/libs/*.jar
          retention-days: 7
