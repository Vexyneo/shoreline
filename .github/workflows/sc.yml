name: Shoreline CI Suite

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  comprehensive-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # 1. 보안: 비밀값 유출 스캔 (Gitleaks)
      - name: Secret Scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 2. 품질: 코드 스타일 검사 (Checkstyle)
      - name: Checkstyle
        uses: dbelyaev/action-checkstyle@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          level: warning

      # 3. 보안: 오픈소스 라이브러리 취약점 스캔 (Trivy)
      - name: Dependency Vulnerability Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'table'
          severity: 'CRITICAL,HIGH'

      # 4. 품질: 빌드 및 유닛 테스트
      - name: Build and Test
        run: ./gradlew build

      # 5. 품질: 테스트 커버리지 리포트 (JaCoCo)
      - name: Test Coverage Report
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: ${{ github.workspace }}/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-projects: 80

      # 6. 보안: 정적 분석 결과 업로드 (이미 있는 CodeQL과 별개로 보강)
      - name: Upload Build Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: shoreline-reports
          path: build/reports/
